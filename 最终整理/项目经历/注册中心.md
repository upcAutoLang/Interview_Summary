# 注册中心

## 1. 主题和服务怎么支持分布式？

ZK 管理集群 (Cluster Manager)，**管理内容为 war 包级别**。信息在 ZK 的 /CLUSTER/ADDRESS 各节点上；节点上有服务信息，如服务中英文名称、IP、端口、说明描述、版本、类型等。

资源目录管理系统 (ds) 注册服务和主题，主题是 XML 级别，每个主题对应一个主题服务的 subjectConfig 下的 xml 文件。

## 2. 服务的注册与发现

### (1) 业务组的服务注册与发现

AbstractRegisterService # register 注册方法。

1. 主题启动时，RegisterServiceSimple 的 Spring Bean 的 init-method 方法中进行 register() 注册；
2. 读取 subjectConfig, resourceConfig 的所有 xml 文件内容；
3. 对所有主题信息，进行注册 register()，注册过程中进行发布 publish()；发布后会将主题、服务信息存在数据库表中。

对于**集群管理系统**与**资源目录管理系统 (ds)** 分别讨论：

- **集群管理系统**
	- 管理粒度为 war 包级别，元数据信息在 ZK 上进行注册；
	- 在服务启动时，服务会在 ZK 上注册服务地址；服务下线时，服务会触发对应的 ZK 节点的更新，告知该服务已经下线；
	- 整体思路与 Dubbo 依赖于 Zookeeper 是相同的，项目组自研的集群管理系统将各服务注册到 ZK 节点 <code>/XXRW_APP</code> 下，每个服务节点的元数据信息都以 JSON 字符串形式存在 ZK 节点上；
- **资源目录管理系统 (ds)**
	- 管理粒度为主题级别（XML 文件形式），元数据信息存在数据库的 DS\_RESOURCE\_NEW 表中存储；
	- 服务启动后，服务会在 ds 上注册所有主题地址，以及服务本身的地址。注册的方法是调用 ds 的主题，向数据库中存入主题相关信息；
	- 服务关闭后，不会立即触发数据库中对应信息的更新，但 ds 系统每半小时轮询一次，更新所有的主题信息。

### (2) Dubbo 的服务注册与发现

Dubbo 的服务注册与发现原理见[《Dubbo》篇](../Dubbo.md)

## 3. 负载均衡调度？和 Nginx 的区别？

注册中心负载均衡：**客户端实现**，有随机 (RandomLoadBalance)，IP Hash，一致性 Hash (ConsistentHashLoadBalance)；  

**为什么客户端实现负载均衡？如果用 Nginx 实现负载均衡，应该怎么实现？如果超过了 Nginx 的单机负载均衡极限，应该怎么继续扩容？F5，LVS？**

Nginx 主要作用：扩容、反向代理、负载均衡、网关；

七层（应用层）/四层（传输层）负载均衡模型

## 4. 订单与订阅？为什么广播？

订单：订阅者 + 被订阅者的组合；

- 订阅者包含 IP、端口、传输协议、主机号等信息 (ProtocalInfo)；
- 被订阅者可以理解为 Kafka 的 Topic；

订单的数据存储：

1. 在数据库中存储订单信息，对应的服务为 subMgr；
2. 存储在 kafka 的 topic 中；在这种订阅的使用情景下，需要使用 Kafka 的广播模式；

订阅：

1. 填充订单信息，将订单存入数据库；

2. Kafka 订阅（如果订阅失败，将存入数据库的订单从数据库删除）

   - **<font color=red>订单的分发？</font>**
   - 分发后处理，对订单进行 MD5 编码处理；
   - 从库中获取并删除旧订单；
   - 订单信息保存本地库与本地内存，并异步启动订阅线程，将订单通过 Kafka 发送；
   - 处理订单：每个订单有一个线程池，该线程池不断循环的从订单对应的 topic 队列中拉去信息 (poll(6000))；拉取的信息反序列化后，用观察者模式的形式通知给各订阅了该订单的消息；

## 5. 平时订阅的主题，与 Kafka 是怎么对应的？订单与 Kafka 的物理对应？（topic, partition）

**为什么只有一个 partition？是否可以发布多个？**

发布时回发布一个 topic，发布 topic 的时候可以指定几个 partition，但一方面，多个 partition 适合在不在意处理顺序的情况下使用；另外一方面，业务支撑提供给外界的接口不能指定 partition；

## 6. 订单号与流水号的意义？是否幂等？

不处理幂等问题；对于处理错误的订单，需要业务组将信息存入内存，自行处理；

## 7. 服务是怎么做降级？熔断？限流的？

限流：guava 的 RateLimiter。
