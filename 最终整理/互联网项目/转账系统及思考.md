操作描述：用户 A 向用户 B 转账，两个用户可能不是同一个银行。

**1. 用户 A 扣除金额**：

本地事务：

1. 用户 A 扣除金额；
2. 用户 A 所在银行添加流水，并设置流水状态**未处理**。

流水表内容：

- 交易号
- 转出用户 ID
- 转入用户 ID
- 转入银行
- 转账金额
- 操作时间
- 流水状态（已执行、未执行等）

执行事务的判断条件：

1. 用户 A 金额扣除后的余额大于 0；
2. 乐观锁判断，操作版本号 version = version + 1；

该步骤完成了用户 A 转账操作的持久化。

**2. 线程轮询，批量执行流水**：

开启线程，轮询查询一定时间范围内未执行过的流水。执行流水时，发起对用户 B 所在银行 RPC 服务的调用。

**3. 用户 B 添加金额**：

用户 B 所在银行事务：

1. 用户 B 添加金额；
2. 添加转账记录，实现幂等性，避免转账操作因为多次调用而多次添加金额情况的出现；

**4. 修改流水信息**

用户 B  所在银行的 RPC 服务调用完毕，返回结果。  
如果返回结果成功，则将用户 A 的转账流水修改为**已处理**状态。